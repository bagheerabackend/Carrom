{% extends "common.html" %}
{% load static %}
{% block title %}App Settings{% endblock title %}
{% block heading %}App Settings{% endblock heading %}
{% block content %}
<div class="mx-auto mt-8 px-4">
    <div class="w-full">

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="p-6">
                <div class="flex flex-wrap gap-2">
                    {% if add %}
                    <button id="addSettingsBtn"
                        class="inline-flex items-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-md transition-colors"
                        onclick="openAddSettingsModal()">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Add Settings
                    </button>
                    {% else %}
                    <button id="editSettingsBtn"
                        class="inline-flex items-center px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-medium rounded-md transition-colors"
                        onclick="openEditSettingsModal()">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5M18.5 2.5a2.121 2.121 0 113 3L12 15l-4 1 1-4 9.5-9.5z" />
                        </svg>
                        Edit Settings
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Settings Table -->
        <div class="bg-white rounded-lg shadow-md">
            <div class="px-6 flex justify-between py-4 border-b border-gray-200">
                <h3 class="flex items-center text-lg font-semibold text-gray-900">
                    <svg class="w-5 h-5 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M11.049 2.927c.3-.921 1.603-.921 1.902 0a1.724 1.724 0 002.573.949c.813-.471 1.828.275 1.514 1.153a1.724 1.724 0 002.234 2.234c.878-.314 1.624.701 1.153 1.514a1.724 1.724 0 00.949 2.573c.921.3.921 1.603 0 1.902a1.724 1.724 0 00-.949 2.573c.471.813-.275 1.828-1.153 1.514a1.724 1.724 0 00-2.234 2.234c.314.878-.701 1.624-1.514 1.153a1.724 1.724 0 00-2.573.949c-.3.921-1.603.921-1.902 0a1.724 1.724 0 00-2.573-.949c-.813.471-1.828-.275-1.514-1.153a1.724 1.724 0 00-2.234-2.234c-.878.314-1.624-.701-1.153-1.514a1.724 1.724 0 00-.949-2.573c-.921-.3-.921-1.603 0-1.902a1.724 1.724 0 00.949-2.573c-.471-.813.275-1.828 1.153-1.514a1.724 1.724 0 002.234-2.234c-.314-.878.701-1.624 1.514-1.153.971.562 2.193-.29 2.573-.949z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    App Settings
                </h3>
            </div>
            <div class="p-6">
                <!-- Error Message -->
                <div id="errorMessage" class="bg-red-50 border border-red-200 rounded-md p-4 mb-4 hidden">
                    <div class="flex">
                        <svg class="w-5 h-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                                clip-rule="evenodd"></path>
                        </svg>
                        <div class="flex-1">
                            <span id="errorText" class="text-red-800"></span>
                            <button type="button" class="float-right text-red-400 hover:text-red-600"
                                onclick="hideError()">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                        clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Success Message -->
                <div id="successMessage" class="bg-green-50 border border-green-200 rounded-md p-4 mb-4 hidden">
                    <div class="flex">
                        <svg class="w-5 h-5 text-green-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <div class="flex-1">
                            <span id="successText" class="text-green-800"></span>
                            <button type="button" class="float-right text-green-400 hover:text-green-600"
                                onclick="hideSuccess()">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                        clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                {% if not add %}
                <div class="overflow-x-auto">
                    <table id="settingsTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Name
                                </th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Value
                                </th>
                            </tr>
                        </thead>
                        <tbody id="settingsTableBody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    Version Code
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {{version}}
                                </td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    Maintenance Mode
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {{maintenance_mode}}
                                </td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    Maintenance Message
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {{maintenance_message}}
                                </td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    GST Percentage
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {{gst_percentage}}%
                                </td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    TDS Percentage (Withdrawal)
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {{tds_percentage}}%
                                </td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    Bonus Point
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {{bonus_point}}
                                </td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    Minimum Withdrawal Amount
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    ₹{{withdrawal_limit}}
                                </td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    Daily Withdrawal Count
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {{daily_withdraw_count}}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div id="emptyState" class="text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M11.049 2.927c.3-.921 1.603-.921 1.902 0a1.724 1.724 0 002.573.949c.813-.471 1.828.275 1.514 1.153a1.724 1.724 0 002.234 2.234c.878-.314 1.624.701 1.153 1.514a1.724 1.724 0 00.949 2.573c.921.3.921 1.603 0 1.902a1.724 1.724 0 00-.949 2.573c.471.813-.275 1.828-1.153 1.514a1.724 1.724 0 00-2.234 2.234c.314.878-.701 1.624-1.514 1.153a1.724 1.724 0 00-2.573.949c-.3.921-1.603.921-1.902 0a1.724 1.724 0 00-2.573-.949c-.813.471-1.828-.275-1.514-1.153a1.724 1.724 0 00-2.234-2.234c-.878.314-1.624-.701-1.153-1.514a1.724 1.724 0 00-.949-2.573c-.921-.3-.921-1.603 0-1.902a1.724 1.724 0 00.949-2.573c-.471-.813.275-1.828 1.153-1.514a1.724 1.724 0 002.234-2.234c-.314-.878.701-1.624 1.514-1.153.971.562 2.193-.29 2.573-.949z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <h4 class="text-lg font-medium text-gray-900 mb-2">No Settings Found</h4>
                    <p class="text-gray-500">Add settings to get started.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Settings Modal -->
<div id="settingsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4" id="modalTitle">Add Settings</h3>
            <form id="settingsForm">
                <div class="mb-4">
                    <label for="version" class="block text-sm font-medium text-gray-700 mb-2">Version Code</label>
                    <input type="text" id="version" name="version" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="mb-4">
                    <label for="maintenanceMode" class="block text-sm font-medium text-gray-700 mb-2">Maintenance Mode</label>
                    <select id="maintenanceMode" name="maintenance_mode" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select</option>
                        <option value="true">Enabled</option>
                        <option value="false">Disabled</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="maintenanceMessage" class="block text-sm font-medium text-gray-700 mb-2">Maintenance Message</label>
                    <textarea id="maintenanceMessage" name="maintenance_message" rows="3"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <div class="mb-4">
                    <label for="gstPercentage" class="block text-sm font-medium text-gray-700 mb-2">GST Percentage (%)</label>
                    <input type="number" id="gstPercentage" name="gst_percentage" required min="0" max="100" step="0.01"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="mb-4">
                    <label for="tdsPercentage" class="block text-sm font-medium text-gray-700 mb-2">TDS Percentage (%) - Withdrawal</label>
                    <input type="number" id="tdsPercentage" name="tds_percentage" required min="0" max="100" step="0.01"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="mb-4">
                    <label for="bonusPoint" class="block text-sm font-medium text-gray-700 mb-2">Bonus Point</label>
                    <input type="number" id="bonusPoint" name="bonus_point" required min="0" step="0.01"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="mb-4">
                    <label for="withdrawalLimit" class="block text-sm font-medium text-gray-700 mb-2">Minimum Withdrawal Amount (₹)</label>
                    <input type="number" id="withdrawalLimit" name="withdrawal_limit" required min="0" step="0.01"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="mb-4">
                    <label for="dailyWithdrawCount" class="block text-sm font-medium text-gray-700 mb-2">Daily Withdrawal Count</label>
                    <input type="number" id="dailyWithdrawCount" name="daily_withdraw_count" required min="0"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancelBtn"
                        class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium rounded-md transition-colors">
                        Cancel
                    </button>
                    <button type="submit"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md transition-colors">
                        <span id="submitText">Add Settings</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        const config = {
            addUrl: '{% url "add_settings" %}',
            editUrl: '{% url "edit_settings" %}',
            csrfToken: '{{ csrf_token }}',
            currentSettingId: null,
            isEditMode: {% if not add %}true{% else %}false{% endif %}
        };

        init();

        function init() {
            setupEventListeners();
        }

        function setupEventListeners() {
            // Modal form submission
            $('#settingsForm').on('submit', function (e) {
                e.preventDefault();
                submitSettingsForm();
            });

            // Cancel button
            $('#cancelBtn').on('click', function () {
                closeModal();
            });

            // Close modal when clicking outside
            $('#settingsModal').on('click', function (e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        }

        function submitSettingsForm() {
            const formData = new FormData($('#settingsForm')[0]);
            let url = config.addUrl;
            
            // If editing, use edit URL with ID
            if (config.isEditMode && config.currentSettingId) {
                url = `${config.editUrl}${config.currentSettingId}/`;
            }
            
            $.ajax({
                url: url,
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': config.csrfToken
                },
                success: function (response) {
                    closeModal();
                    const message = config.isEditMode ? 'Settings updated successfully!' : 'Settings added successfully!';
                    showSuccessMessage(message);
                    // Reload page to show updated settings
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                },
                error: function (xhr) {
                    let errorMessage = 'Failed to save settings';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    showError(errorMessage);
                }
            });
        }

        function closeModal() {
            $('#settingsModal').addClass('hidden');
            $('#settingsForm')[0].reset();
            config.currentSettingId = null;
        }

        // Global functions for button actions
        window.openAddSettingsModal = function () {
            $('#modalTitle').text('Add Settings');
            $('#submitText').text('Add Settings');
            $('#settingsForm')[0].reset();
            config.currentSettingId = null;
            $('#settingsModal').removeClass('hidden');
        };

        window.openEditSettingsModal = function () {
            $('#modalTitle').text('Edit Settings');
            $('#submitText').text('Update Settings');
            
            // Pre-fill form with current values
            $('#version').val('{{version}}');
            $('#maintenanceMode').val('{{maintenance_mode}}');
            $('#maintenanceMessage').val('{{maintenance_message}}');
            $('#gstPercentage').val('{{gst_percentage}}');
            $('#tdsPercentage').val('{{tds_percentage}}');
            $('#bonusPoint').val('{{bonus_point}}');
            $('#withdrawalLimit').val('{{withdrawal_limit}}');
            $('#dailyWithdrawCount').val('{{daily_withdraw_count}}');
            
            // Set the setting ID (you'll need to pass this from your view)
            config.currentSettingId = '{{ setting_id|default:"" }}';
            
            $('#settingsModal').removeClass('hidden');
        };

        // Utility functions
        function showError(message) {
            $('#errorText').text(message);
            $('#errorMessage').removeClass('hidden');
            // Auto-hide after 5 seconds
            setTimeout(hideError, 5000);
        }

        function hideError() {
            $('#errorMessage').addClass('hidden');
        }

        function showSuccess(message) {
            $('#successText').text(message);
            $('#successMessage').removeClass('hidden');
            // Auto-hide after 3 seconds
            setTimeout(hideSuccess, 3000);
        }

        function hideSuccess() {
            $('#successMessage').addClass('hidden');
        }

        function showSuccessMessage(message) {
            showSuccess(message);
        }

        // Global functions for hiding messages
        window.hideSuccess = hideSuccess;
        window.hideError = hideError;
    });
</script>
{% endblock content %}